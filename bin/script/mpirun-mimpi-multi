#!/bin/sh
#set -x


#
#  params
#
NS_HOST=as1.lab.inf.uc3m.es
NS_PORT=5527
NS_PATH=~opa/MiMPI/bin
TEST_PATH=~opa/MiMPI/test/performance/linux/mimpi/llcbench/mpbench
COMPRESS=BEST_SPEED
#COMPRESS=BEST_COMPRESS
#COMPRESS=NO_COMPRESS
LOW=1
HIGH=4194304
#HIGH=1048576
MACHINES=~opa/MiMPI/bin/machines.LINUX
RSH=rsh


#
# message
#
MESSAGE[0]="MPI_BCAST_LIST_SYNC"
MESSAGE[1]="MPI_BCAST_LIST_SYNC"
MESSAGE[2]="MPI_BCAST_LIST_ASYNC " 
MESSAGE[3]="MPI_BCAST_LIST_ASYNC "
MESSAGE[4]="MPI_BCAST_LIST_JOIN "
MESSAGE[5]="MPI_BCAST_LIST_JOIN "
MESSAGE[6]="MPI_BCAST_LIST_DISJOIN "
MESSAGE[7]="MPI_BCAST_LIST_DISJOIN "
MESSAGE[8]="MPI_BCAST_TREE_SYNC "
MESSAGE[9]="MPI_BCAST_TREE_SYNC "
MESSAGE[10]="MPI_BCAST_TREE_ASYNC "
MESSAGE[11]="MPI_BCAST_TREE_ASYNC "
MESSAGE[12]="MPI_BCAST_TREE_JOIN "
MESSAGE[13]="MPI_BCAST_TREE_JOIN "
MESSAGE[14]="MPI_BCAST_TREE_DISJOIN "
MESSAGE[15]="MPI_BCAST_TREE_DISJOIN "
MESSAGE[16]="MPI_BCAST_TREE_CHAIN "
MESSAGE[17]="MPI_BCAST_TREE_CHAIN "
MESSAGE[18]="MPI_REDUCE_LIST_SYNC "
MESSAGE[19]="MPI_REDUCE_LIST_SYNC "
MESSAGE[20]="MPI_REDUCE_LIST_ASYNC "
MESSAGE[21]="MPI_REDUCE_LIST_ASYNC "
MESSAGE[22]="MPI_REDUCE_LIST_JOIN "
MESSAGE[23]="MPI_REDUCE_LIST_JOIN "
MESSAGE[24]="MPI_REDUCE_LIST_JOINLESS "
MESSAGE[25]="MPI_REDUCE_LIST_JOINLESS "
MESSAGE[26]="MPI_REDUCE_ONE_SYNC "
MESSAGE[27]="MPI_REDUCE_ONE_SYNC"


#
#  r_run_1
#
r_run_1 ()
{
  if [ $# -ne 4 ]; then
	echo ""
	echo "	Usage: r_run_1 <n_prog> <id_prog> <r_host> <r_test>"
	echo ""
	exit 1
  fi

  RN=$1
  RI=$2
  RHOST=$3
  RTEST=$4

$RSH $RHOST "( cd $TEST_PATH/ ; env  MPI_BCAST_LIST_SYNC_LOW=${PARAMS[0]}       MPI_BCAST_LIST_SYNC_HIGH=${PARAMS[1]}   MPI_BCAST_LIST_ASYNC_LOW=${PARAMS[2]}   MPI_BCAST_LIST_ASYNC_HIGH=${PARAMS[3]}  MPI_BCAST_LIST_JOIN_LOW=${PARAMS[4]}    MPI_BCAST_LIST_JOIN_HIGH=${PARAMS[5]}   MPI_BCAST_LIST_DISJOIN_LOW=${PARAMS[6]} MPI_BCAST_LIST_DISJOIN_HIGH=${PARAMS[7]}  MPI_BCAST_TREE_SYNC_LOW=${PARAMS[8]}  MPI_BCAST_TREE_SYNC_HIGH=${PARAMS[9]}   MPI_BCAST_TREE_ASYNC_LOW=${PARAMS[10]}  MPI_BCAST_TREE_ASYNC_HIGH=${PARAMS[11]} MPI_BCAST_TREE_JOIN_LOW=${PARAMS[12]}   MPI_BCAST_TREE_JOIN_HIGH=${PARAMS[13]}  MPI_BCAST_TREE_DISJOIN_LOW=${PARAMS[14]} MPI_BCAST_TREE_DISJOIN_HIGH=${PARAMS[15]} MPI_BCAST_TREE_CHAIN_LOW=${PARAMS[16]} MPI_BCAST_TREE_CHAIN_HIGH=${PARAMS[17]}   MPI_REDUCE_LIST_SYNC_LOW=${PARAMS[18]} MPI_REDUCE_LIST_SYNC_HIGH=${PARAMS[19]}  MPI_REDUCE_LIST_ASYNC_LOW=${PARAMS[20]} MPI_REDUCE_LIST_ASYNC_HIGH=${PARAMS[21]}  MPI_REDUCE_LIST_JOIN_LOW=${PARAMS[22]} MPI_REDUCE_LIST_JOIN_HIGH=${PARAMS[23]} MPI_REDUCE_LIST_JOINLESS_LOW=${PARAMS[24]} MPI_REDUCE_LIST_JOINLESS_HIGH=${PARAMS[25]} MPI_REDUCE_ONE_SYNC_LOW=${PARAMS[26]} MPI_REDUCE_ONE_SYNC_HIGH=${PARAMS[27]}   COMPRESSION=$COMPRESS  NS_HOST=$NS_HOST NS_PORT=$NS_PORT _N_PROCS=$RN _PROC_ID=$RI ./$RTEST )" &
 }



#
#  total_run
#
total_run ()
{
NL=`wc -l $MACHINES| awk '{print $1}'`
IL=1

NP=$PROG_NUMBER
IP=0

while [ $IP -lt $NP ]; do
	LINE=`head -n $IL $MACHINES| tail -n 1`
        PCNAME=`echo $LINE | awk -F: '{print $1}'`

	r_run_1 $NP $IP $PCNAME "$PROG_NAME"
        IP=`expr $IP + 1`

        IL=`expr $IL + 1`
	if [ $IL -gt $NL ]; then
		IL=1
	fi
done


sh -c "( cd $NS_PATH/ ; env COMPRESSION=$COMPRESS NS_HOST=$NS_HOST NS_PORT=$NS_PORT _N_PROCS=$RN _PROC_ID=$RN ./ns.exe )"
}


#
# inicializar a cero PARAMS
#
inicializar ()
{
INICIALIZAR_A=("0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27")

for A in $INICIALIZAR_A; do
	PARAMS[$A]=0
done
}


#
# imprime PARAMS
#
imprimir ()
{
IMPRIMIR_A=("0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27")

for A in $IMPRIMIR_A; do
	echo -n ${PARAMS[$A]}
	echo -n " "
done
}


 
#
#  main
#
if [ $# -ne 3 ]; then
	echo ""
	echo "	Usage: mpirun -np <n_prog> <r_test>"
	echo ""
	exit 1
fi

PROG_NUMBER=$2
PROG_NAME=$3
MAIN_B=("8 12 14 16 10 2 0 8 4 6")

for B in $MAIN_B; do
	# trace
	echo ${MESSAGE[$B]}
	echo `date +%k:%M`
	sleep 15

	# killer on
	./mpikill-mimpi &

	# go
	inicializar  
	PARAMS[$B]=$LOW
	PARAMS[`expr $B + 1`]=$HIGH

	total_run $PROG_NUMBER $PROG_NAME

	# killer off
	killall mpikill-mimpi
done


